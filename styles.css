/* Base */
:root{
  --bg1:#4facfe;
  --bg2:#00f2fe;
  --paper1:#f6ead2;
  --paper2:#f1e1c5;
  --ink:#5a4632;
  --ink2:#24445f;
  --shadow: rgba(0,0,0,0.18);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  overflow:hidden;
  font-family:"Georgia",serif;
  color:var(--ink);
}

/* Flowing water background */
.water-bg{
  position:fixed; inset:0;
  background: radial-gradient(1200px 800px at 30% 20%, rgba(120, 180, 255, 0.22), transparent 58%),
              radial-gradient(900px 600px at 70% 80%, rgba(110, 255, 240, 0.10), transparent 62%),
              linear-gradient(160deg, #0b2a5c 0%, #0b3b74 42%, #0a2e66 72%, #0a2352 100%);
  background-size: 400% 400%;
  animation: waterFlow 28s ease-in-out infinite;
  z-index:-2;
}
.ripple-layer{
  position:fixed; inset:0;
  background:
    radial-gradient(ellipse at 20% 50%, rgba(255,255,255,0.10) 0%, transparent 54%),
    radial-gradient(ellipse at 80% 20%, rgba(150, 230, 255, 0.08) 0%, transparent 50%),
    radial-gradient(ellipse at 40% 80%, rgba(120, 255, 235, 0.06) 0%, transparent 56%);
  animation: ripple 22s ease-in-out infinite alternate;
  z-index:-1;
}
@keyframes waterFlow { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
@keyframes ripple { 0%{transform:scale(1) translate(0,0)} 100%{transform:scale(1.1) translate(20px,-10px)} }

/* WebGL ocean canvas (primary) */
#ocean-bg{
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100%;
  z-index: -3;
  display: block;
}

/* If WebGL is active, make it the primary background (avoid covering it). */
body.webgl-bg .water-bg,
body.webgl-bg .ripple-layer{
  opacity: 0;
}

/* Controls */
.controls{
  position:fixed;
  top:16px; left:16px;
  z-index:50;
  display:flex;
  align-items:center;
  gap:10px;
}
button{
  background: rgba(255,255,255,0.20);
  border: 1px solid rgba(255,255,255,0.40);
  color: #fff;
  padding: 10px 18px;
  cursor: pointer;
  border-radius: 999px;
  backdrop-filter: blur(10px);
  transition: transform .2s, background .2s, box-shadow .2s;
  font-family: inherit;
  font-size: 14px;
}
button:hover{
  background: rgba(255,255,255,0.32);
  transform: translateY(-1px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.12);
}
button.ghost{ background: rgba(255,255,255,0.12); }
button.danger{ background: rgba(255, 80, 80, 0.18); border-color: rgba(255,80,80,0.35); }

.status{
  margin-left:6px;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 12px;
  color: rgba(255,255,255,0.92);
  background: rgba(0,0,0,0.18);
  border: 1px solid rgba(255,255,255,0.20);
}
.status.ok{ background: rgba(20, 140, 90, 0.22); border-color: rgba(120, 255, 200, 0.22); }
.status.bad{ background: rgba(160, 60, 60, 0.22); border-color: rgba(255, 160, 160, 0.22); }

/* Canvas / boxes */
#canvas{
  position:relative;
  z-index:10;
  width:100%;
  height:100%;
}
.empty-state{
  position:absolute;
  left:50%;
  top:42%;
  transform: translate(-50%, -50%);
  text-align:center;
  padding: 18px 18px 16px;
  width: min(420px, calc(100vw - 44px));
  color: rgba(255,255,255,0.92);
  background: rgba(0,0,0,0.10);
  border: 1px solid rgba(255,255,255,0.16);
  border-radius: 18px;
  backdrop-filter: blur(10px);
  box-shadow: 0 20px 60px rgba(0,0,0,0.18);
}
.empty-title{
  font-size: 18px;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}
.empty-sub{
  font-size: 13px;
  opacity: 0.92;
}
.empty-sub b{
  font-weight: 700;
}

.seal-banner{
  padding: 10px 12px;
  border-radius: 14px;
  background: rgba(0,0,0,0.12);
  border: 1px solid rgba(255,255,255,0.18);
  color: rgba(255,255,255,0.92);
  font-size: 12px;
  line-height: 18px;
  backdrop-filter: blur(10px);
}
.seal-banner[hidden]{ display:none !important; }
.box{
  width: 140px;
  height: 88px;
  /* light brown, polished wood w/ subtle grain (still-life look) */
  background:
    radial-gradient(160px 90px at 30% 18%, rgba(255,255,255,0.22), rgba(255,255,255,0.0) 60%),
    radial-gradient(180px 120px at 70% 88%, rgba(0,0,0,0.16), rgba(0,0,0,0.0) 62%),
    repeating-linear-gradient(
      0deg,
      rgba(255,255,255,0.045) 0px,
      rgba(255,255,255,0.045) 1px,
      rgba(0,0,0,0.00) 10px,
      rgba(0,0,0,0.00) 20px
    ),
    linear-gradient(180deg, #e1bf8a 0%, #d2ab73 28%, #c3975e 60%, #b2814b 78%, #a77441 100%);
  position: absolute;
  border-radius: 22px;
  box-shadow:
    0 18px 50px rgba(0,0,0,0.28),
    inset 0 1px 0 rgba(255,255,255,0.30),
    inset 0 -18px 26px rgba(0,0,0,0.22);
  cursor: grab;
  border: 1px solid rgba(255,255,255,0.20);
  transition: transform 0.2s, box-shadow 0.2s;
  transform-style: preserve-3d;
}
.box.sealed{
  filter: grayscale(1) saturate(0.05);
  opacity: 0.68;
}
.box.sealed .latch{
  filter: grayscale(1) brightness(0.9);
}
.box.ritual-seal{
  animation: ritualShake 780ms cubic-bezier(0.2,0.9,0.2,1);
}
.box.ritual-open{
  animation: ritualOpen 700ms cubic-bezier(0.2,0.9,0.2,1);
}
@keyframes ritualShake{
  0%{ transform: translateY(0) rotate(0deg) scale(1); }
  18%{ transform: translateY(-3px) rotate(-2deg) scale(1.02); }
  36%{ transform: translateY(2px) rotate(2deg) scale(1.02); }
  54%{ transform: translateY(-2px) rotate(-1.5deg) scale(1.01); }
  72%{ transform: translateY(1px) rotate(1deg) scale(1.01); }
  100%{ transform: translateY(0) rotate(0deg) scale(1); }
}
@keyframes ritualOpen{
  0%{ transform: translateY(0) scale(1); filter: brightness(1); }
  45%{ transform: translateY(-3px) scale(1.04); filter: brightness(1.08); }
  100%{ transform: translateY(0) scale(1); filter: brightness(1); }
}
.ritual-sticker{
  position:absolute;
  left: 50%;
  top: -22px;
  transform: translateX(-50%);
  width: 74px;
  height: 34px;
  border-radius: 999px;
  background: rgba(255,255,255,0.92);
  color: rgba(25, 40, 60, 0.88);
  display:flex;
  align-items:center;
  justify-content:center;
  gap: 8px;
  box-shadow: 0 18px 46px rgba(0,0,0,0.20);
  border: 1px solid rgba(255,255,255,0.60);
  pointer-events:none;
  animation: stickerPop 1200ms cubic-bezier(0.2,0.9,0.2,1) forwards;
}
.ritual-sticker svg{
  width: 18px;
  height: 18px;
  fill: rgba(25, 40, 60, 0.78);
}
.ritual-sticker .txt{
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 0.2px;
}
@keyframes stickerPop{
  0%{ opacity:0; transform: translateX(-50%) translateY(10px) scale(0.86); }
  25%{ opacity:1; transform: translateX(-50%) translateY(0px) scale(1.03); }
  72%{ opacity:1; transform: translateX(-50%) translateY(-2px) scale(1.00); }
  100%{ opacity:0; transform: translateX(-50%) translateY(-10px) scale(0.98); }
}
.box:active{ cursor:grabbing; }
.box:hover{
  transform: translateY(-2px) scale(1.03);
  box-shadow: 0 22px 54px rgba(0,0,0,0.30);
}
.box::before{
  /* slightly domed lid */
  content:'';
  position:absolute;
  left: 0;
  right: 0;
  top: 0;
  height: 48px;
  background:
    radial-gradient(220px 110px at 52% 0%, rgba(255,255,255,0.28), rgba(255,255,255,0.0) 62%),
    radial-gradient(160px 70px at 55% 10%, rgba(255,255,255,0.14), rgba(255,255,255,0.0) 65%),
    repeating-linear-gradient(
      0deg,
      rgba(255,255,255,0.04) 0px,
      rgba(255,255,255,0.04) 1px,
      rgba(0,0,0,0.00) 10px,
      rgba(0,0,0,0.00) 20px
    ),
    linear-gradient(180deg, #ecd0a0 0%, #dfbf89 45%, #cda46a 100%);
  border-radius: 22px 22px 20px 20px;
  pointer-events:none;
  box-shadow:
    inset 0 -1px 0 rgba(0,0,0,0.14),
    0 12px 18px rgba(0,0,0,0.10);
}
.box::after{
  /* lid seam line */
  content:'';
  position:absolute;
  left: 16px;
  right: 16px;
  top: 46px;
  height: 2px;
  background: linear-gradient(90deg, rgba(0,0,0,0.00), rgba(0,0,0,0.22), rgba(0,0,0,0.00));
  border-radius: 999px;
  pointer-events:none;
}

/* Vintage brass latch on the LEFT front (viewer perspective) */
.box .latch{
  position:absolute;
  left: 18px;
  top: 44px;
  width: 26px;
  height: 28px;
  border-radius: 8px 8px 10px 10px;
  background:
    radial-gradient(18px 12px at 30% 18%, rgba(255,255,255,0.55), rgba(255,255,255,0.0) 62%),
    linear-gradient(180deg, #caa55f 0%, #a67d38 40%, #7d5a24 100%);
  box-shadow:
    0 10px 18px rgba(0,0,0,0.22),
    inset 0 1px 0 rgba(255,255,255,0.22),
    inset 0 -2px 3px rgba(0,0,0,0.18);
  border: 1px solid rgba(80,55,18,0.35);
  pointer-events:none;
}
.box .latch::after{
  /* keyhole hint */
  content:'';
  position:absolute;
  left: 50%;
  top: 12px;
  transform: translateX(-50%);
  width: 6px;
  height: 10px;
  border-radius: 3px;
  background: rgba(60,40,14,0.65);
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.12);
}
.label{
  position:absolute;
  bottom:-8px;
  left:50%;
  transform: translateX(-50%);
  background: rgba(255,255,255,0.92);
  color: var(--ink);
  padding: 3px 10px;
  font-size: 11px;
  border-radius: 4px;
  white-space: nowrap;
  max-width: 110px;
  overflow: hidden;
  text-overflow: ellipsis;
  box-shadow: 0 2px 6px rgba(0,0,0,0.10);
}

/* Scroll overlay */
#scroll-overlay{
  position:fixed; inset:0;
  background: rgba(79, 172, 254, 0.25);
  backdrop-filter: blur(6px);
  z-index:200;
  display:none;
  justify-content:center;
  align-items:center;
  opacity:0;
  transition: opacity 0.35s;
}
#scroll-paper{
  width: min(620px, calc(100vw - 40px));
  height: min(82vh, 760px);
  background:
    radial-gradient(120% 90% at 50% 0%, rgba(255,255,255,0.45), transparent 60%),
    radial-gradient(120% 90% at 50% 100%, rgba(0,0,0,0.06), transparent 55%),
    radial-gradient(700px 420px at 20% 30%, rgba(255,255,255,0.18), transparent 65%),
    radial-gradient(620px 360px at 80% 70%, rgba(0,0,0,0.05), transparent 65%),
    linear-gradient(180deg, var(--paper1) 0%, var(--paper2) 55%, #efdcbf 100%);
  border-radius: 18px;
  box-shadow: 0 26px 70px rgba(0,0,0,0.22);
  position: relative;
  padding: 54px 34px 26px;
  display:flex;
  flex-direction:column;
  transform: scale(0.95) translateY(18px);
  clip-path: inset(0 0 88% 0 round 18px);
  transition: transform 0.55s cubic-bezier(0.175,0.885,0.32,1.275), clip-path 0.7s cubic-bezier(0.2,0.9,0.2,1);
  overflow:hidden;
}
#scroll-paper.ritual-seal-scroll{
  animation: scrollSealShake 860ms cubic-bezier(0.2,0.9,0.2,1);
}
@keyframes scrollSealShake{
  0%{ transform: scale(1) translateY(0) rotate(0deg); }
  18%{ transform: scale(1.01) translateY(-3px) rotate(-0.8deg); }
  36%{ transform: scale(1.01) translateY(2px) rotate(0.9deg); }
  54%{ transform: scale(1.005) translateY(-2px) rotate(-0.6deg); }
  72%{ transform: scale(1.003) translateY(1px) rotate(0.35deg); }
  100%{ transform: scale(1) translateY(0) rotate(0deg); }
}

.confetti-layer{
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index:8;
}
.confetti{
  position:absolute;
  top: 18px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 22px;
  opacity: 0;
  animation: confettiPop 1200ms cubic-bezier(0.2,0.9,0.2,1) forwards;
  filter: drop-shadow(0 10px 18px rgba(0,0,0,0.18));
}
.confetti.c1{ left: 44%; animation-delay: 0ms; }
.confetti.c2{ left: 50%; animation-delay: 60ms; }
.confetti.c3{ left: 56%; animation-delay: 120ms; }
.confetti.c4{ left: 38%; animation-delay: 90ms; }
.confetti.c5{ left: 62%; animation-delay: 150ms; }
@keyframes confettiPop{
  0%{ opacity:0; transform: translateX(-50%) translateY(10px) scale(0.9); }
  22%{ opacity:1; transform: translateX(-50%) translateY(0px) scale(1.08); }
  70%{ opacity:1; transform: translateX(-50%) translateY(-12px) scale(1.0); }
  100%{ opacity:0; transform: translateX(-50%) translateY(-26px) scale(0.98); }
}
#scroll-overlay.open #scroll-paper{
  transform: scale(1) translateY(0);
  clip-path: inset(0 0 0 0 round 18px);
}

#scroll-paper::before, #scroll-paper::after{
  content:'';
  position:absolute;
  left:0; right:0;
  height:70px;
  background:
    radial-gradient(90% 140% at 50% 0%, rgba(0,0,0,0.26), transparent 62%),
    radial-gradient(110% 130% at 50% 100%, rgba(255,255,255,0.35), transparent 60%),
    linear-gradient(180deg, #f0ddb9 0%, #e9cf9f 50%, #e0bf82 100%);
  border-radius: 999px;
  opacity: 0.95;
  filter: drop-shadow(0 10px 22px rgba(0,0,0,0.18));
  z-index:0;
  pointer-events:none;
}
#scroll-paper::before{ top:-42px; }
#scroll-paper::after{ bottom:-42px; transform: rotate(180deg); }

.side-curl{
  position:absolute;
  top:22px; bottom:22px;
  width:26px;
  pointer-events:none;
  opacity:0.9;
  z-index:0;
}
.side-curl.left{ left:-6px; background: radial-gradient(22px 55px at 0% 50%, rgba(0,0,0,0.14), transparent 70%); }
.side-curl.right{ right:-6px; background: radial-gradient(22px 55px at 100% 50%, rgba(0,0,0,0.14), transparent 70%); }

.close-btn{
  position:absolute;
  top:14px; right:14px;
  width:36px; height:36px;
  background:#fff;
  border-radius:999px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  border: none;
  color:#8b7355;
  font-size:18px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.14);
  z-index:5;
}
.close-btn.small{ width:32px; height:32px; font-size:16px; }

#box-title-edit{
  border:none;
  background: transparent;
  font-size: 18px;
  color: var(--ink);
  text-align:center;
  width:100%;
  outline:none;
  font-family: "Georgia", serif;
  margin: 2px 0 14px;
  z-index:2;
}

#chat-area{
  flex:1;
  overflow-y:auto;
  padding-right: 6px;
  z-index:2;
  font-family: "Kaiti SC","STKaiti","KaiTi","Songti SC",serif;
  line-height: 30px;
}
#chat-area::-webkit-scrollbar{ width:4px; }
#chat-area::-webkit-scrollbar-thumb{ background: rgba(90,70,50,0.25); border-radius: 2px; }

.message{
  margin: 0 0 14px;
  white-space: pre-wrap;
}
.message.user{ color: var(--ink2); }
.message.agent{ color: var(--ink); opacity:0.92; }
.message.typing{
  display: inline-flex;
  align-items: center;
  gap: 8px;
  opacity: 0.75;
}
.typing-dots{
  display:inline-flex;
  gap: 4px;
  align-items:center;
}
.typing-dots span{
  width: 6px;
  height: 6px;
  border-radius: 999px;
  background: rgba(90,70,50,0.75);
  animation: dotBounce 1.1s infinite ease-in-out;
}
.typing-dots span:nth-child(2){ animation-delay: 0.12s; }
.typing-dots span:nth-child(3){ animation-delay: 0.24s; }
@keyframes dotBounce{
  0%, 80%, 100% { transform: translateY(0); opacity: 0.55; }
  40% { transform: translateY(-5px); opacity: 0.95; }
}

.input-area{
  display:flex;
  flex-direction:column;
  gap: 10px;
  padding-top: 10px;
  z-index:2;
}
#user-input{
  width:100%;
  border:none;
  outline:none;
  resize:none;
  background: transparent;
  color: var(--ink);
  min-height: 74px;
  line-height: 28px;
  font-size: 15px;
  font-family: "Kaiti SC","STKaiti","KaiTi","Songti SC",serif;
}
#user-input::placeholder{ color: rgba(90,70,50,0.35); }

.composer{
  display:flex;
  align-items:center;
  gap: 10px;
  padding: 8px 12px;
  border-radius: 16px;
  background: rgba(255,255,255,0.18);
  border: 1px solid rgba(255,255,255,0.22);
  backdrop-filter: blur(10px);
  box-shadow: 0 18px 48px rgba(0,0,0,0.18);
}
.attach-btn{
  width: 48px;
  height: 48px;
  min-width: 48px;
  padding: 0;
  border-radius: 16px;
  background: rgba(255,255,255,0.40);
  border: 1px solid rgba(255,255,255,0.22);
  color: rgba(0,0,0,0.55);
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow: 0 10px 24px rgba(0,0,0,0.10);
}
.attach-btn:hover{
  background: rgba(255,255,255,0.55);
  transform: translateY(-1px);
}
.attach-btn:disabled{
  opacity: 0.55;
  cursor: not-allowed;
  transform:none;
}
.composer #user-input{
  flex: 1 1 auto;
  width: auto;
  min-width: 0;
  min-height: 48px;
  height: 48px; /* looks single-line by default; JS will auto-grow */
  font-size: 16px;
  line-height: 28px; /* taller caret */
  padding: 10px 8px;
  overflow-y: hidden; /* JS toggles to auto when reaching max height */
}
.send-btn{
  width: 48px;
  height: 48px;
  min-width: 48px;
  padding: 0;
  border-radius: 16px;
  background: rgba(255,255,255,0.55);
  border: 1px solid rgba(0,0,0,0.08);
  color: var(--ink);
  box-shadow: 0 10px 24px rgba(0,0,0,0.12);
  display:flex;
  align-items:center;
  justify-content:center;
  backdrop-filter: blur(10px);
}
.attach-btn svg,
.send-btn svg{
  width: 26px;
  height: 26px;
  display: block;
}
.send-btn:hover{
  background: rgba(255,255,255,0.72);
  transform: translateY(-1px);
}
.send-btn:disabled{
  cursor: not-allowed;
  opacity: 0.55;
  transform: none;
  box-shadow: none;
}

.seal-area{
  display:flex;
  justify-content:center;
  padding: 6px 0 2px;
}
.seal-area button{
  padding: 14px 22px;
  min-width: 84px;
  font-size: 14px;
  background: rgba(139, 115, 85, 0.12);
  color: #6b5344;
  border: 1px solid rgba(139, 115, 85, 0.32);
  border-radius: 999px;
  box-shadow: 0 10px 22px rgba(0,0,0,0.12);
}
.seal-area button:hover{
  background: rgba(139, 115, 85, 0.18);
  transform: translateY(-1px);
}
.seal-area button:disabled{
  cursor: not-allowed;
  opacity: 0.55;
  transform: none;
  box-shadow: none;
}

.btn-icon{
  display:flex;
  align-items:center;
  justify-content:center;
}
.btn-icon svg{ fill: currentColor; }
/* Toggle only inside the send button (avoid affecting other buttons) */
.send-btn .icon-stop{ display:none; }
.send-btn.is-sending .icon-send{ display:none; }
.send-btn.is-sending .icon-stop{ display:block; }

.attachment{
  display:flex;
  flex-direction: column;
  align-items:stretch;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 16px;
  background: rgba(255,255,255,0.20);
  border: 1px solid rgba(255,255,255,0.22);
  backdrop-filter: blur(10px);
  box-shadow: 0 18px 48px rgba(0,0,0,0.16);
}
.attachment[hidden]{
  display: none !important;
}
.attachment-list{
  display:flex;
  flex-wrap: wrap;
  gap: 10px;
}
.attachment-item{
  position: relative;
  width: 92px;
  height: 64px;
  border-radius: 12px;
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.22);
  box-shadow: 0 10px 22px rgba(0,0,0,0.14);
}
.attachment-item img{
  width: 100%;
  height: 100%;
  object-fit: cover;
  display:block;
}
.attachment-remove{
  position:absolute;
  top: 6px;
  right: 6px;
  width: 24px;
  height: 24px;
  padding: 0;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.30);
  background: rgba(0,0,0,0.22);
  color: rgba(255,255,255,0.95);
  line-height: 24px;
}
.attachment-remove:hover{
  background: rgba(0,0,0,0.30);
  transform: translateY(-1px);
}
.attachment-hint{
  font-size: 12px;
  color: rgba(255,255,255,0.78);
}

/* Settings modal */
#settings-overlay{
  position: fixed;
  inset:0;
  z-index:300;
  display:none;
  justify-content:center;
  align-items:center;
  background: rgba(0,0,0,0.35);
  backdrop-filter: blur(4px);
  opacity:0;
  transition: opacity 0.25s;
}
#settings-panel{
  width: min(560px, calc(100vw - 40px));
  background: rgba(255,255,255,0.92);
  border: 1px solid rgba(255,255,255,0.55);
  border-radius: 18px;
  box-shadow: 0 22px 60px rgba(0,0,0,0.20);
  padding: 18px 18px 16px;
  position: relative;
}
#settings-panel h2{
  margin: 4px 0 14px;
  font-size: 16px;
  color: #2d3a43;
  font-weight: 600;
}
.field{ display:block; margin: 0 0 14px; }
.field-title{ font-size: 13px; color:#2d3a43; margin-bottom: 6px; }
.field input{
  width: 100%;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(0,0,0,0.12);
  outline: none;
  font-size: 13px;
}
.field-hint{ margin-top: 6px; font-size: 12px; color: rgba(45,58,67,0.65); }
.row{ display:flex; gap:10px; justify-content:flex-end; }
.row button{ color:#2d3a43; background: rgba(0,0,0,0.06); border-color: rgba(0,0,0,0.10); }
.row button:hover{ background: rgba(0,0,0,0.10); }
.row button.danger{ color:#7a1f1f; }

